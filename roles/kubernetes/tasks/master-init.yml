---
# Initialize Kubernetes control-plane

- name: Check if Kubernetes is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_init_stat

- name: Deploy kubeadm config from template
  template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml
    mode: '0644'
  when: not k8s_init_stat.stat.exists

- name: Initialize the Kubernetes cluster
  command: kubeadm init --config /etc/kubernetes/kubeadm-config.yaml
  when: not k8s_init_stat.stat.exists
  register: kubeadm_init

- name: Wait for admin.conf
  wait_for:
    path: /etc/kubernetes/admin.conf
    timeout: 180

# -----------------------------
# KUBECONFIG SETUP
# -----------------------------

- name: Create .kube directory for ubuntu
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Copy kubeconfig for ubuntu
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu
    group: ubuntu
    mode: '0644'

# -----------------------------
# Wait API Ready
# -----------------------------

- name: Wait for API server
  become_user: ubuntu
  command: kubectl get nodes
  register: kubectl_ready
  retries: 15
  delay: 10
  until: kubectl_ready.rc == 0
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  changed_when: false

# -----------------------------
# Install Flannel
# -----------------------------

- name: Install Flannel CNI
  become_user: ubuntu
  command: kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

- name: Wait for CoreDNS rollout to complete
  become_user: ubuntu
  command: kubectl rollout status deployment/coredns -n kube-system --timeout=300s
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  changed_when: false

- name: Wait for Flannel rollout
  become_user: ubuntu
  command: kubectl rollout status daemonset/kube-flannel-ds -n kube-flannel --timeout=300s
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  changed_when: false

# -----------------------------
# Remove control-plane taint
# -----------------------------

- name: Allow scheduling on control-plane
  become_user: ubuntu
  command: kubectl taint nodes --all node-role.kubernetes.io/control-plane-
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

# -----------------------------
# Generate Join Command (FACT)
# -----------------------------

- name: Generate join command
  command: kubeadm token create --print-join-command
  register: k8s_join_command
  changed_when: false

- name: Save join command to file on master
  copy:
    content: "{{ k8s_join_command.stdout }}"
    dest: /home/ubuntu/join-command.sh
    owner: ubuntu
    group: ubuntu
    mode: '0755'


- name: Wait for Kubernetes API stability
  become_user: ubuntu
  shell: |
    for i in {1..30}; do
      kubectl get ns >/dev/null 2>&1 && exit 0
      sleep 5
    done
    exit 1
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  changed_when: false
