- name: Remove any existing metrics-server
  become_user: ubuntu
  shell: kubectl delete -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml --ignore-not-found=true
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  ignore_errors: yes

- name: Wait for metrics-server removal
  pause:
    seconds: 15

- name: Apply metrics-server with insecure TLS already included
  become_user: ubuntu
  shell: |
    curl -sL https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml \
    | sed 's/        - --metric-resolution=15s/        - --metric-resolution=15s\n        - --kubelet-insecure-tls\n        - --kubelet-preferred-address-types=InternalIP/' \
    | kubectl apply -f -
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

- name: Wait for metrics-server to be ready
  become_user: ubuntu
  shell: |
    for i in $(seq 1 24); do
      kubectl rollout status deployment metrics-server -n kube-system --timeout=10s 2>/dev/null && exit 0
      echo "Attempt $i/24 - waiting..."
      sleep 15
    done
    exit 0
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config