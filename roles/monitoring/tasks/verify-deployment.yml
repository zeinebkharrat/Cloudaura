---
# Verify monitoring deployment

- name: Wait for all monitoring pods
  become: true
  become_user: ubuntu
  environment:
    HOME: /home/ubuntu
    KUBECONFIG: /home/ubuntu/.kube/config
  command: kubectl wait --for=condition=Ready pods --all -n monitoring --timeout=600s
  changed_when: false
  ignore_errors: yes

- name: Check Prometheus health
  become: true
  become_user: ubuntu
  environment:
    HOME: /home/ubuntu
    KUBECONFIG: /home/ubuntu/.kube/config
  shell: |
    POD=$(kubectl get pod -n monitoring -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[0].metadata.name}')
    kubectl exec -n monitoring $POD -c prometheus -- wget -qO- http://localhost:9090/api/v1/query?query=up 2>/dev/null | grep -q success
  changed_when: false
  retries: 5
  delay: 10

- name: Check Grafana health
  become: true
  become_user: ubuntu
  environment:
    HOME: /home/ubuntu
    KUBECONFIG: /home/ubuntu/.kube/config
  shell: |
    POD=$(kubectl get pod -n monitoring -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].metadata.name}')
    kubectl exec -n monitoring $POD -c grafana -- wget -qO- http://localhost:3000/api/health 2>/dev/null | grep -q ok
  changed_when: false
  retries: 5
  delay: 10
